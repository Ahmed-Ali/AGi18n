#!/usr/bin/env ruby
# encoding: UTF-8

require 'tmpdir'

COMMENTS_REGEXP = /\*(?<text>.*)\*/
LABEL_REGEXP = /^"(?<text>.*)" = ".*";$/

def remove_duplicates(file)
	puts "Removing duplicates from #{file}"	
	
	labels = Hash.new
	comment = ""

	# Parse all the labels from the xib
	File.open(file, 'r:UTF-8').each do |line|

		# Read comments
		md = COMMENTS_REGEXP.match(line)  
		if md  then
			comment = md.captures.first
		end

		# Read label
		md = LABEL_REGEXP.match(line)  
		if md  then
			key = md.captures			
			if labels[key].nil? then
				labels[key] = Hash.new() 
				labels[key][:comment] = comment
				labels[key][:line] = line			
			end
			comment = ""
		end
	end  

	File.open(file, 'w:UTF-8') do |file|	
		labels.keys.sort.each do |key|
			str = key.first
			comment = labels[key][:comment]
			line = labels[key][:line]
			file.puts "\n/* #{comment} */"
			file.puts line
		end
	end

end


current_dir = File.dirname(__FILE__)
languages = Dir["*.lproj"]
puts "#{languages.length} languages detected: #{languages.join(', ')}"

# For each language
languages.each do |dir|
	file = File.join(dir, 'Localizable.strings')
	temp_dir = Dir.tmpdir
	temp_file = File.join(temp_dir, 'Localizable.strings')

	puts "\nInternazionalizing #{dir}..."
	
	# Execute genstrings on new temp file
	puts "Executing `genstrings -littleEndian -o #{temp_dir} **/*.{h,m,mm}`"	
	source_files = Dir["**/*.{h,m,mm}"]
 	`genstrings -littleEndian -o #{temp_dir} "#{source_files.join('" "')}"`
 	
 	# Convert new temp Localizable and original into utf-8
 	puts "Executing `#{current_dir}/agconv #{temp_file}`"
 	`#{current_dir}/agconv #{temp_file}`

	puts "Executing `#{current_dir}/agconv #{file}`"
 	`#{current_dir}/agconv #{file}`

 	# Append results to final Localizable
 	puts "Executing `cat #{temp_file} >> #{file}`"
 	`cat #{temp_file} >> #{file}`

	# Execute genxibstrings appending results	
	puts "Executing `#{current_dir}/genxibstrings -a -o #{dir}`"		
 	`#{current_dir}/genxibstrings -a -o #{dir}`
 	
	# Remove duplicates by order	
	remove_duplicates(file)

end

puts "\n\n* DONE *\nAGi18n finished internazionalizing correctly.\nRemember to use the Localizable.strings files as UTF-8 into your XCode project"
